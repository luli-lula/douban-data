# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a personal Douban data synchronization repository that automatically fetches movie watching records from Douban and processes them for use in a Hugo static site. The project focuses on curating 5-star rated movies and making the data available via GitHub Pages.

## Commands

### Data Processing
- `node scripts/process-csv-simple.js` - Process raw Douban CSV data from `data/raw/movie.csv` into filtered `data/movies.json`

### Manual Workflow Triggers
- Navigate to GitHub Actions → "Sync Douban Data" → "Run workflow" to manually trigger data sync

## Architecture

### Data Flow
1. **GitHub Actions Workflow** (`.github/workflows/sync-douban.yml`) runs daily at Beijing time 00:00 (UTC 16:00)
2. **Doumark Action** (`lizheming/doumark-action`) fetches raw data from Douban user ID 59715677 into `data/raw/movie.csv`
3. **Data Processing** (`scripts/process-csv-simple.js`) creates both display and backup data:
   - Filters 5-star movies for website display (max 100, incremental updates)
   - Creates complete backup of all movie data for data preservation
4. **Image Management** - Downloads movie posters locally and serves via jsDelivr CDN
5. **Auto-commit** pushes JSON data, backup data, and poster images to repository

### Key Files
- `data/movies.json` - Website display data (5-star movies only, max 100 entries)
- `data/backup/all-movies.json` - Complete backup data (all rated movies for preservation)
- `data/stats.json` - Metadata about the data sync (count, last update, rating distribution)
- `data/raw/movie.csv` - Raw Douban CSV data (generated by GitHub Actions)
- `images/posters/{movie_id}.jpg` - Downloaded movie poster images
- `scripts/process-csv-simple.js` - Main data processing script with dual output and incremental updates

### Data Structure

**Website Display Data** (`data/movies.json`):
- 5-star movies only, max 100 entries, sorted by mark_date (descending)
- Fields: `title`, `year`, `rating`, `directors`, `genres`, `poster_url`, `douban_url`, `mark_date`, `comment`, `id`
- `poster_url` uses jsDelivr CDN: `https://cdn.jsdelivr.net/gh/luli-lula/douban-data@main/images/posters/{id}.jpg`

**Complete Backup Data** (`data/backup/all-movies.json`):
- All rated movies (1-5 stars + unrated), unlimited entries, sorted by mark_date (descending)
- Additional fields: `tags`, `intro`, `pubdate`, `douban_rating`
- Serves as complete data preservation against Douban content deletion

### External Dependencies
- **Douban User ID**: 59715677 (hardcoded in workflow and scripts)
- **GitHub Actions**: lizheming/doumark-action for Douban data fetching
- **Hugo Site Integration**: Data consumed via raw GitHub URL at `https://raw.githubusercontent.com/luli-lula/douban-data/main/data/movies.json`

## Development Notes

- No build process or bundling required - pure Node.js scripts
- Minimal external dependencies (only Node.js built-in modules)
- **Dual Data Strategy**: Maintains both curated display data and complete backup data
- **Incremental Updates**: Only processes new movies, avoiding reprocessing existing data
- **Data Preservation**: Complete backup protects against Douban content deletion/changes
- **Image Management**: Downloads posters locally and serves via jsDelivr CDN for reliability
- Data processing includes year/director extraction from CSV card field
- Repository maintains clean separation between raw, processed, and backup data
- **Usage Pattern**: Designed for low-volume updates (few movies marked per week)
- **Anti-Hotlinking Solution**: Local image storage bypasses Douban's referrer restrictions