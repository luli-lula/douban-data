# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a personal Douban data synchronization repository that automatically fetches movie watching records from Douban and processes them for use in a Hugo static site. The project focuses on curating 5-star rated movies and making the data available via GitHub Pages.

## Commands

### Data Processing
- `npm run process` - Process raw Douban data from `data/raw/movie.json` into filtered `data/movies.json` with poster download
- `npm run test` - Run data validation tests (via `scripts/test-data.js`)
- `node scripts/test-download.js` - Test image download functionality

### Manual Workflow Triggers
- Navigate to GitHub Actions → "Sync Douban Data" → "Run workflow" to manually trigger data sync

## Architecture

### Data Flow
1. **GitHub Actions Workflow** (`.github/workflows/sync-douban.yml`) runs daily at Beijing time 00:00 (UTC 16:00)
2. **Doumark Action** (`lizheming/doumark-action`) fetches raw data from Douban user ID 59715677 into `data/raw/movie.json`
3. **Data Processing** (`scripts/process-data.js`) filters for 5-star movies, downloads poster images, and outputs to `data/movies.json`
4. **Image Storage** - Movie posters are downloaded to `images/posters/` and served via jsDelivr CDN
5. **Auto-commit** pushes both JSON data and poster images back to the repository

### Key Files
- `data/movies.json` - Final processed data (5-star movies only, max 100 entries)
- `data/stats.json` - Metadata about the data sync (count, last update, etc.)
- `data/raw/movie.json` - Raw Douban data (generated by GitHub Actions)
- `images/posters/{movie_id}.jpg` - Downloaded movie poster images
- `scripts/process-data.js` - Main data processing and image download logic
- `scripts/test-download.js` - Image download functionality testing

### Data Structure
Movies are filtered to 5-star ratings only and sorted by mark_date (descending). Each movie object contains:
- `title`, `year`, `rating`, `directors`, `genres`
- `poster_url` (jsDelivr CDN URLs: `https://cdn.jsdelivr.net/gh/luli-lula/douban-data@main/images/posters/{movie_id}.jpg`)
- `douban_url`, `mark_date`, `comment`, `id`

### External Dependencies
- **Douban User ID**: 59715677 (hardcoded in workflow and scripts)
- **GitHub Actions**: lizheming/doumark-action for Douban data fetching
- **Hugo Site Integration**: Data consumed via raw GitHub URL at `https://raw.githubusercontent.com/luli-lula/douban-data/main/data/movies.json`

## Development Notes

- No build process or bundling required - pure Node.js scripts
- Minimal external dependencies (only https module for image downloads)
- Data processing includes year extraction from movie titles when year field is missing
- Repository maintains a clean separation between raw data (`data/raw/`) and processed data (`data/`)
- **Anti-bot measures**: Image downloads use proper User-Agent headers and referrer to bypass Douban's anti-hotlinking
- **CDN Integration**: All poster images are served via jsDelivr CDN for reliable access from external sites
- **Fallback handling**: If image download fails, original Douban URLs are preserved as fallback