# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a personal Douban data synchronization repository that automatically fetches movie watching records and book reading records from Douban and processes them for use in a Hugo static site. The project focuses on curating 5-star rated movies and books, making the data available via GitHub Pages.

## Commands

### Data Processing
- `node scripts/process-csv-movies.js` - Process raw Douban CSV data from `data/raw/movie.csv` into filtered `data/movies.json`
- `node scripts/process-csv-books.js` - Process raw Douban CSV data from `data/raw/book.csv` into filtered `data/books.json`

### Manual Workflow Triggers
- Navigate to GitHub Actions → "Sync Douban Movies Data" → "Run workflow" to manually trigger movie data sync
- Navigate to GitHub Actions → "Sync Douban Books Data" → "Run workflow" to manually trigger book data sync

## Architecture

### Data Flow

**Movies:**
1. **GitHub Actions Workflow** (`.github/workflows/sync-douban-movies.yml`) runs daily at Beijing time 00:00 (UTC 16:00)
2. **Doumark Action** (`lizheming/doumark-action`) fetches raw movie data from Douban user ID 59715677 into `data/raw/movie.csv`
3. **Data Processing** (`scripts/process-csv-movies.js`) creates both display and backup data:
   - Filters 5-star movies for website display (max 100, incremental updates)
   - Creates complete backup of all movie data for data preservation
4. **Image Management** - Downloads movie posters locally and serves via jsDelivr CDN
5. **Auto-commit** pushes raw CSV data, JSON data, backup data, and poster images to repository

**Books:**
1. **GitHub Actions Workflow** (`.github/workflows/sync-douban-books.yml`) runs daily at Beijing time 01:00 (UTC 17:00)
2. **Doumark Action** (`lizheming/doumark-action`) fetches raw book data from Douban user ID 59715677 into `data/raw/book.csv`
3. **Data Processing** (`scripts/process-csv-books.js`) creates both display and backup data:
   - Filters 5-star books for website display (max 100, incremental updates)
   - Creates complete backup of all book data for data preservation
4. **Image Management** - Downloads book covers locally and serves via jsDelivr CDN
5. **Auto-commit** pushes raw CSV data, JSON data, backup data, and cover images to repository

### Key Files

**Movie Data:**
- `data/movies.json` - Website display data (5-star movies only, max 100 entries)
- `data/backup/movies-backup.json` - Complete backup data (all rated movies for preservation)
- `data/movie-stats.json` - Metadata about the movie data sync (count, last update, rating distribution)
- `data/raw/movie.csv` - Raw Douban movie CSV data (generated by GitHub Actions)
- `images/movies/{movie_id}.jpg` - Downloaded movie poster images
- `scripts/process-csv-movies.js` - Main movie data processing script with dual output and incremental updates

**Book Data:**
- `data/books.json` - Website display data (5-star books only, max 100 entries)
- `data/backup/books-backup.json` - Complete backup data (all rated books for preservation)
- `data/book-stats.json` - Metadata about the book data sync (count, last update, rating distribution)
- `data/raw/book.csv` - Raw Douban book CSV data (generated by GitHub Actions)
- `images/books/{book_id}.jpg` - Downloaded book cover images
- `scripts/process-csv-books.js` - Main book data processing script with dual output and incremental updates

### Data Structure

**Movie Website Display Data** (`data/movies.json`):
- 5-star movies only, max 100 entries, sorted by mark_date (descending)
- Fields: `title`, `year`, `rating`, `directors`, `genres`, `poster_url`, `douban_url`, `mark_date`, `comment`, `id`
- `poster_url` uses jsDelivr CDN: `https://cdn.jsdelivr.net/gh/luli-lula/douban-data@main/images/movies/{id}.jpg`

**Movie Complete Backup Data** (`data/backup/movies-backup.json`):
- All rated movies (1-5 stars + unrated), unlimited entries, sorted by mark_date (descending)
- Additional fields: `tags`, `intro`, `pubdate`, `douban_rating`
- Serves as complete data preservation against Douban content deletion

**Book Website Display Data** (`data/books.json`):
- 5-star books only, max 100 entries, sorted by mark_date (descending)
- Fields: `title`, `year`, `rating`, `authors`, `publisher`, `genres`, `cover_url`, `douban_url`, `mark_date`, `comment`, `id`
- `cover_url` uses jsDelivr CDN: `https://cdn.jsdelivr.net/gh/luli-lula/douban-data@main/images/books/{id}.jpg`

**Book Complete Backup Data** (`data/backup/books-backup.json`):
- All rated books (1-5 stars + unrated), unlimited entries, sorted by mark_date (descending)
- Additional fields: `tags`, `intro`, `pubdate`, `douban_rating`
- Serves as complete data preservation against Douban content deletion

### External Dependencies
- **Douban User ID**: 59715677 (hardcoded in workflow and scripts)
- **GitHub Actions**: lizheming/doumark-action for Douban data fetching
- **Hugo Site Integration**: 
  - Movie data consumed via: `https://raw.githubusercontent.com/luli-lula/douban-data/main/data/movies.json`
  - Book data consumed via: `https://raw.githubusercontent.com/luli-lula/douban-data/main/data/books.json`

## Development Notes

- No build process or bundling required - pure Node.js scripts
- Minimal external dependencies (only Node.js built-in modules)
- **Dual Data Strategy**: Maintains both curated display data and complete backup data for both movies and books
- **Incremental Updates**: Only processes new movies/books, avoiding reprocessing existing data
- **Data Preservation**: Complete backup protects against Douban content deletion/changes
- **Image Management**: Downloads posters/covers locally and serves via jsDelivr CDN for reliability
- Data processing includes year/director/author extraction from CSV card field
- Repository maintains clean separation between raw, processed, and backup data
- **Usage Pattern**: Designed for low-volume updates (few movies/books marked per week)
- **Anti-Hotlinking Solution**: Local image storage bypasses Douban's referrer restrictions
- **Separate Workflows**: Movies and books sync independently with different schedules (1 hour apart)