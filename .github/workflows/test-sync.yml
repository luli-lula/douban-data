name: Test Douban Sync

on:
  workflow_dispatch: # 仅手动触发用于测试

jobs:
  test-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Sync Douban JSON Data
        uses: lizheming/doumark-action@master
        with:
          id: 59715677
          type: movie
          format: json
          status: done
          dir: ./data/raw
          
      - name: List generated files
        run: |
          echo "=== 检查生成的文件 ==="
          ls -la ./data/raw/
          echo "=== JSON 文件内容 ==="
          if [ -f "./data/raw/movie.json" ]; then
            echo "JSON文件大小: $(wc -c < ./data/raw/movie.json) 字节"
            echo "JSON数组长度: $(jq '. | length' ./data/raw/movie.json)"
            echo "第一个电影示例:"
            jq '.[0]' ./data/raw/movie.json
          else
            echo "JSON文件不存在"
          fi
          
      - name: Check git status
        run: |
          echo "=== Git状态检查 ==="
          git status
          git add -A
          git status
          
      - name: Commit test results
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '🧪 同步豆瓣原始数据'
          file_pattern: 'data/raw/*'
          commit_author: 'Douban Sync <sync@douban.local>'