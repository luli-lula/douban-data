name: Test Douban Sync

on:
  workflow_dispatch: # 仅手动触发用于测试

jobs:
  test-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Sync Douban CSV Data
        uses: lizheming/doumark-action@master
        with:
          id: 59715677
          type: movie
          format: csv
          status: done
          dir: ./data/raw
          
      - name: List generated files
        run: |
          echo "=== 检查生成的文件 ==="
          ls -la ./data/raw/
          echo "=== JSON 文件内容 ==="
          if [ -f "./data/raw/movie.json" ]; then
            echo "JSON文件大小: $(wc -c < ./data/raw/movie.json) 字节"
            echo "JSON数组长度: $(jq '. | length' ./data/raw/movie.json)"
            echo "第一个电影示例:"
            jq '.[0]' ./data/raw/movie.json
          else
            echo "JSON文件不存在"
          fi
          
      - name: Fix file permissions
        run: |
          echo "=== 修复文件权限 ==="
          sudo chown -R runner:docker ./data/raw/
          ls -la ./data/raw/
          
      - name: Commit test results
        uses: EndBug/add-and-commit@v8
        with:
          message: '🧪 同步豆瓣原始数据'
          add: './data/raw'