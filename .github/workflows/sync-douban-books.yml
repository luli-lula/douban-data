name: Sync Douban Books Data

on:
  schedule:
    # æ¯å‘¨æ—¥UTC 17ç‚¹ (åŒ—äº¬æ—¶é—´å‘¨ä¸€1ç‚¹) åŒæ­¥ä¹¦ç±æ•°æ®
    - cron: '0 17 * * 0'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create raw data directory
        run: mkdir -p ./data/raw
        
      - name: Sync Douban Books Data
        uses: lizheming/doumark-action@master
        with:
          id: 59715677  # ä½ çš„è±†ç“£ç”¨æˆ·ID
          type: book
          format: csv
          # status: done  # å·²è¯»å®Œçš„ä¹¦ç± - ä¸æŒ‡å®šstatuså‚æ•°ï¼Œè·å–æ‰€æœ‰çŠ¶æ€
          dir: ./data/raw
          
      - name: Debug - Check generated files
        run: |
          echo "Contents of data/raw directory:"
          ls -la ./data/raw/ || echo "Directory not found"
          echo "Book CSV file info:"
          ls -la ./data/raw/book.csv || echo "book.csv not found"
          if [ -f "./data/raw/book.csv" ]; then
            echo "First few lines of book.csv:"
            head -5 ./data/raw/book.csv
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
          
      - name: Fix file permissions
        run: |
          sudo chown -R runner:docker ./data/raw/ || true
          
      - name: Clean CSV file (fix encoding and quote issues)
        run: |
          if [ -f "./data/raw/book.csv" ]; then
            echo "æ¸…ç†book.csvï¼Œä¿®å¤ç¼–ç å’Œå¼•å·é—®é¢˜..."
            # å¤‡ä»½åŸæ–‡ä»¶
            cp ./data/raw/book.csv ./data/raw/book.csv.backup
            
            # ä½¿ç”¨Node.jsè„šæœ¬æ¸…ç†CSVï¼Œä¿®å¤ç¼–ç å’Œå¼•å·é—®é¢˜
            node -e "
              const fs = require('fs');
              try {
                const csvContent = fs.readFileSync('./data/raw/book.csv', 'utf8');
                const lines = csvContent.split('\n');
                
                console.log('åŸå§‹CSVè¡Œæ•°:', lines.length);
                
                const cleanLines = [];
                const header = 'id,title,poster,pubdate,url,rating,genres,star,comment,tags,star_time,card';
                cleanLines.push(header);
                
                let processedBooks = 0;
                
                // ä¿®å¤CSVå¼•å·å’Œç¼–ç é—®é¢˜
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i].trim();
                  if (!line || !line.includes('book.douban.com/subject/') || !line.match(/^\d+/)) {
                    continue;
                  }
                  
                  try {
                    // å…ˆä¿®å¤å¸¸è§çš„å¼•å·é—®é¢˜
                    let cleanedLine = line
                      .replace(/\"/g, '\"\"')  // è½¬ä¹‰å†…éƒ¨å¼•å·
                      .replace(/([^,])\"([^,])/g, '\$1\"\"\$2')  // ä¿®å¤ä¸­é—´çš„å¼•å·
                      .replace(/\"([^\"]*?)([,\n])/g, '\"\$1\"\$2');  // ç¡®ä¿å­—æ®µè¢«æ­£ç¡®å¼•ç”¨
                    
                    // ä½¿ç”¨æ›´robustçš„æ–¹å¼è§£æCSVè¡Œ
                    const csvRegex = /(?:^|,)(\"(?:[^\"]|\"\")*\"|[^,]*)/g;
                    const fields = [];
                    let match;
                    
                    while ((match = csvRegex.exec(cleanedLine)) !== null) {
                      let field = match[1];
                      if (field.startsWith('\"') && field.endsWith('\"')) {
                        field = field.slice(1, -1).replace(/\"\"/g, '\"');
                      }
                      fields.push(field);
                    }
                    
                    if (fields.length >= 10) {
                      // æå–å…³é”®å­—æ®µ
                      const bookId = fields[0];
                      const title = fields[1] || '';
                      let posterUrl = '';
                      let doubanUrl = '';
                      let rating = '';
                      let genres = '';
                      
                      // æ‰¾åˆ°è±†ç“£URLå’Œç›¸å…³å­—æ®µ
                      for (let j = 0; j < fields.length; j++) {
                        if (fields[j] && fields[j].includes('dou.img.lithub.cc')) {
                          posterUrl = fields[j];
                        } else if (fields[j] && fields[j].includes('book.douban.com/subject/')) {
                          doubanUrl = fields[j];
                          if (j + 1 < fields.length) rating = fields[j + 1] || '';
                          if (j + 2 < fields.length) genres = fields[j + 2] || '';
                        }
                      }
                      
                      // ä»æœ«å°¾æå–å›ºå®šå­—æ®µ
                      const card = fields[fields.length - 1] || '';
                      const star_time = fields[fields.length - 2] || '';
                      const tags = fields[fields.length - 3] || '';
                      const comment = fields[fields.length - 4] || '';
                      const star = fields[fields.length - 5] || '';
                      
                      // æ¸…ç†genreså­—æ®µï¼Œç§»é™¤å¯èƒ½å¯¼è‡´è§£æé—®é¢˜çš„å­—ç¬¦
                      const cleanGenres = genres.replace(/[\"\n\r]/g, '').replace(/,/g, 'ï¼Œ');
                      
                      const cleanedParts = [
                        bookId,
                        title.replace(/[\"\n\r]/g, ''),
                        posterUrl,
                        '',  // pubdate
                        doubanUrl,
                        rating,
                        cleanGenres,
                        star,
                        comment.replace(/[\"\n\r]/g, ''),
                        tags.replace(/[\"\n\r]/g, ''),
                        star_time,
                        card.replace(/[\"\n\r]/g, '')
                      ];
                      
                      cleanLines.push(cleanedParts.join(','));
                      processedBooks++;
                    }
                  } catch (e) {
                    console.log('å¤„ç†ä¹¦ç±è¡Œå¤±è´¥ (è¡Œ ' + (i+1) + '):', e.message);
                    console.log('é—®é¢˜è¡Œå†…å®¹:', line.substring(0, 200) + '...');
                  }
                }
                
                fs.writeFileSync('./data/raw/book.csv', cleanLines.join('\n'));
                console.log('æ¸…ç†åCSVè¡Œæ•°:', cleanLines.length);
                console.log('æˆåŠŸå¤„ç†ä¹¦ç±æ•°:', processedBooks);
                console.log('CSVæ¸…ç†å®Œæˆï¼');
              } catch (error) {
                console.error('æ¸…ç†CSVå¤±è´¥:', error.message);
                process.exit(1);
              }
            "
          else
            echo "book.csv not found, skipping cleanup"
          fi
          
      - name: Process CSV data and filter 5-star books
        run: |
          if [ -f "./data/raw/book.csv" ]; then
            echo "Processing book.csv..."
            node scripts/process-csv-books.js
          else
            echo "âš ï¸  book.csv not found, skipping processing"
          fi
          
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          message: 'ğŸ“š æ›´æ–°è±†ç“£ä¹¦ç±æ•°æ®'
          add: 'data/raw/book.csv data/books.json data/book-stats.json data/backup/books-backup.json images/books/*'