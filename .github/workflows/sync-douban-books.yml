name: Sync Douban Books Data

on:
  schedule:
    # æ¯å‘¨æ—¥UTC 17ç‚¹ (åŒ—äº¬æ—¶é—´å‘¨ä¸€1ç‚¹) åŒæ­¥ä¹¦ç±æ•°æ®
    - cron: '0 17 * * 0'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create raw data directory
        run: mkdir -p ./data/raw
        
      - name: Sync Douban Books Data
        uses: lizheming/doumark-action@master
        continue-on-error: true
        id: sync_books
        with:
          id: 59715677  # ä½ çš„è±†ç“£ç”¨æˆ·ID
          type: book
          format: csv
          status: done  # å·²è¯»å®Œçš„ä¹¦ç±ï¼Œä¸ç”µå½±ä¿æŒä¸€è‡´
          dir: ./data/raw
          
      - name: Check sync result and debug
        run: |
          echo "=== æ£€æŸ¥è±†ç“£æ•°æ®åŒæ­¥ç»“æœ ==="
          if [ "${{ steps.sync_books.outcome }}" = "failure" ]; then
            echo "âš ï¸ è±†ç“£æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå°†ä½¿ç”¨ç°æœ‰æ•°æ®ç»§ç»­å¤„ç†"
            echo "SYNC_FAILED=true" >> $GITHUB_ENV
          else
            echo "âœ… è±†ç“£æ•°æ®åŒæ­¥æˆåŠŸ"
            echo "SYNC_FAILED=false" >> $GITHUB_ENV
          fi
          
          echo "Contents of data/raw directory:"
          ls -la ./data/raw/ || echo "Directory not found"
          echo "Book CSV file info:"
          ls -la ./data/raw/book.csv || echo "book.csv not found"
          if [ -f "./data/raw/book.csv" ]; then
            echo "First few lines of book.csv:"
            head -5 ./data/raw/book.csv
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install
          
      - name: Fix file permissions
        run: |
          sudo chown -R runner:docker ./data/raw/ || true
          
      - name: Clean CSV file (fix encoding and quote issues)
        if: env.SYNC_FAILED == 'false'
        run: |
          if [ -f "./data/raw/book.csv" ]; then
            echo "æ¸…ç†book.csvï¼Œä¿®å¤ç¼–ç å’Œå¼•å·é—®é¢˜..."
            # å¤‡ä»½åŸæ–‡ä»¶
            cp ./data/raw/book.csv ./data/raw/book.csv.backup
            
            # ä½¿ç”¨Node.jsè„šæœ¬æ¸…ç†CSVï¼Œä¿®å¤ç¼–ç å’Œå¼•å·é—®é¢˜
            node -e "
              const fs = require('fs');
              try {
                const csvContent = fs.readFileSync('./data/raw/book.csv', 'utf8');
                const lines = csvContent.split('\n');
                
                console.log('åŸå§‹CSVè¡Œæ•°:', lines.length);
                
                const cleanLines = [];
                const header = 'id,title,poster,pubdate,url,rating,genres,star,comment,tags,star_time,card';
                cleanLines.push(header);
                
                let processedBooks = 0;
                
                // ä¿®å¤CSVå¼•å·å’Œç¼–ç é—®é¢˜
                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i].trim();
                  if (!line || !line.includes('book.douban.com/subject/') || !line.match(/^\d+/)) {
                    continue;
                  }
                  
                  try {
                    // ä½¿ç”¨ç®€åŒ–ä½†æ›´é²æ£’çš„æ–¹å¼å¤„ç†CSVè¡Œ
                    // å…ˆå°è¯•é€šè¿‡è±†ç“£IDå’ŒURLæ¥å®šä½å…³é”®å­—æ®µ
                    const bookIdMatch = line.match(/^(\d+),/);
                    const doubanUrlMatch = line.match(/(https:\/\/book\.douban\.com\/subject\/\d+\/)/);
                    
                    if (!bookIdMatch || !doubanUrlMatch) {
                      console.log('è·³è¿‡æ— æ•ˆè¡Œ:', line.substring(0, 100));
                      continue;
                    }
                    
                    const bookId = bookIdMatch[1];
                    const doubanUrl = doubanUrlMatch[1];
                    
                    // æå–è¯„åˆ†ï¼ˆåœ¨è±†ç“£URLåé¢ï¼‰
                    const ratingPattern = new RegExp(doubanUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ',([^,]*),');
                    const ratingMatch = line.match(ratingPattern);
                    const rating = ratingMatch ? ratingMatch[1] : '';
                    
                    // æå–genreså­—æ®µï¼ˆåœ¨ratingåé¢ï¼Œä½†éœ€è¦å°å¿ƒå¤„ç†é€—å·ï¼‰
                    let genresStartIndex = -1;
                    if (ratingMatch) {
                      genresStartIndex = line.indexOf(ratingMatch[0]) + ratingMatch[0].length;
                    }
                    
                    // ä»åå¾€å‰æå–å›ºå®šå­—æ®µ
                    const parts = line.split(',');
                    const card = parts[parts.length - 1] || '';
                    const star_time = parts[parts.length - 2] || '';
                    const tags = parts[parts.length - 3] || '';
                    const comment = parts[parts.length - 4] || '';
                    const star = parts[parts.length - 5] || '';
                    
                    // æå–æ ‡é¢˜ - ä»cardå­—æ®µä¸­è·å–æ›´å¯é 
                    let title = '';
                    const cardParts = card.split(' / ');
                    if (cardParts.length >= 1) {
                      title = cardParts[0].replace(/^\[.*?\]\s*/, '').trim();
                    }
                    if (!title) {
                      title = `Book_${bookId}`;
                    }
                    
                    // æå–genres - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›´ç²¾ç¡®åœ°å®šä½
                    let genres = '';
                    if (genresStartIndex > 0) {
                      const genresEndPattern = new RegExp(',' + star.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ',' + comment.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                      const genresEndMatch = line.match(genresEndPattern);
                      if (genresEndMatch) {
                        const genresEndIndex = line.indexOf(genresEndMatch[0]);
                        genres = line.substring(genresStartIndex, genresEndIndex);
                      }
                    }
                    
                    // æ„é€ å­—æ®µæ•°ç»„ç”¨äºåç»­å¤„ç†
                    const fields = [
                      bookId,
                      title,
                      '', // poster - ç¨åä»lineä¸­æå–
                      '', // pubdate
                      doubanUrl,
                      rating,
                      genres,
                      star,
                      comment,
                      tags,
                      star_time,
                      card
                    ];
                    
                    // æå–å°é¢URL
                    const posterMatch = line.match(/https:\/\/dou\.img\.lithub\.cc\/book\/[^,]+\.jpg/);
                    if (posterMatch) {
                      fields[2] = posterMatch[0];
                    }
                    
                    if (fields.length >= 10) {
                      // å­—æ®µå·²ç»åœ¨ä¸Šé¢æ­£ç¡®æå–ï¼Œç›´æ¥ä½¿ç”¨
                      const finalBookId = fields[0];
                      const finalTitle = fields[1];
                      const posterUrl = fields[2];
                      const finalDoubanUrl = fields[4];
                      const finalRating = fields[5];
                      const finalGenres = fields[6];
                      const finalStar = fields[7];
                      const finalComment = fields[8];
                      const finalTags = fields[9];
                      const finalStarTime = fields[10];
                      const finalCard = fields[11];
                      
                      // æ¸…ç†genreså­—æ®µï¼Œç§»é™¤å¯èƒ½å¯¼è‡´è§£æé—®é¢˜çš„å­—ç¬¦
                      const cleanGenres = finalGenres.replace(/[\"\n\r]/g, '').replace(/,/g, 'ï¼Œ').replace(/'/g, '');
                      
                      const cleanedParts = [
                        finalBookId,
                        finalTitle.replace(/[\"\n\r]/g, ''),
                        posterUrl,
                        '',  // pubdate
                        finalDoubanUrl,
                        finalRating,
                        cleanGenres,
                        finalStar,
                        finalComment.replace(/[\"\n\r]/g, ''),
                        finalTags.replace(/[\"\n\r]/g, ''),
                        finalStarTime,
                        finalCard.replace(/[\"\n\r]/g, '')
                      ];
                      
                      cleanLines.push(cleanedParts.join(','));
                      processedBooks++;
                    }
                  } catch (e) {
                    console.log('å¤„ç†ä¹¦ç±è¡Œå¤±è´¥ (è¡Œ ' + (i+1) + '):', e.message);
                    console.log('é—®é¢˜è¡Œå†…å®¹:', line.substring(0, 200) + '...');
                  }
                }
                
                fs.writeFileSync('./data/raw/book.csv', cleanLines.join('\n'));
                console.log('æ¸…ç†åCSVè¡Œæ•°:', cleanLines.length);
                console.log('æˆåŠŸå¤„ç†ä¹¦ç±æ•°:', processedBooks);
                console.log('CSVæ¸…ç†å®Œæˆï¼');
              } catch (error) {
                console.error('æ¸…ç†CSVå¤±è´¥:', error.message);
                process.exit(1);
              }
            "
          else
            echo "book.csv not found, skipping cleanup"
          fi
          
      - name: Process CSV data and filter 5-star books
        run: |
          if [ "${{ env.SYNC_FAILED }}" = "false" ] && [ -f "./data/raw/book.csv" ]; then
            echo "Processing book.csv..."
            node scripts/process-csv-books.js
          else
            echo "âš ï¸ åŒæ­¥å¤±è´¥æˆ–book.csvä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†ã€‚ä½¿ç”¨ç°æœ‰æ•°æ®æˆ–é‡æ–°å¤„ç†å·²æœ‰æ–‡ä»¶ã€‚"
            # å¦‚æœæœ‰ç°å­˜çš„book.csvï¼Œå°è¯•é‡æ–°å¤„ç†
            if [ -f "./data/raw/book.csv" ]; then
              echo "å‘ç°ç°æœ‰book.csvæ–‡ä»¶ï¼Œå°è¯•é‡æ–°å¤„ç†..."
              node scripts/process-csv-books.js || echo "å¤„ç†å¤±è´¥ï¼Œä¿æŒç°æœ‰æ•°æ®ä¸å˜"
            fi
          fi
          
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          message: |
            ğŸ“š æ›´æ–°è±†ç“£ä¹¦ç±æ•°æ®
            
            åŒæ­¥çŠ¶æ€: ${{ env.SYNC_FAILED == 'false' && 'âœ… æˆåŠŸ' || 'âš ï¸ éƒ¨åˆ†å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰æ•°æ®' }}
          add: 'data/raw/book.csv data/books.json data/book-stats.json data/backup/books-backup.json images/books/*'